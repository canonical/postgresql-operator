integration: commands_pre[0]> poetry install --only integration --no-root
Installing dependencies from lock file

No dependencies to install or update
integration: commands_pre[1]> poetry export --only main,charm-libs --output requirements.txt
integration: commands[0]> poetry run pytest -v --tb native --log-cli-level=INFO -s --ignore=/home/ubuntu/postgresql-operator-16/tests/unit/ --keep-models -vv --controller lxd --model dev1 tests/integration/test_audit.py
[1m============================= test session starts ==============================[0m
platform linux -- Python 3.12.3, pytest-8.3.2, pluggy-1.5.0 -- /home/ubuntu/postgresql-operator-16/.tox/integration/bin/python
cachedir: .tox/integration/.pytest_cache
rootdir: /home/ubuntu/postgresql-operator-16
configfile: pyproject.toml
plugins: github-secrets-0.1.0, operator-0.36.0, asyncio-0.21.2, allure-pytest-collection-report-0.1.0, allure-pytest-2.13.5, operator-groups-0.1.0, operator-cache-0.1.0
asyncio: mode=Mode.AUTO
[1mcollecting ... [0mcollected 1 item

tests/integration/test_audit.py::test_audit_plugin 
[1m-------------------------------- live log setup --------------------------------[0m
[32mINFO    [0m pytest_operator.plugin:plugin.py:724 Adding model lxd:dev1 on cloud localhost
[32mINFO    [0m pytest_operator.plugin:plugin.py:583 Using tmp_path: /home/ubuntu/postgresql-operator-16/.tox/integration/tmp/pytest/dev10
[32mINFO    [0m pytest_operator.plugin:plugin.py:1127 Building charm postgresql
[32mINFO    [0m pytest_operator.plugin:plugin.py:1132 Built charm postgresql in 87.39s
[1m-------------------------------- live log call ---------------------------------[0m
[32mINFO    [0m juju.model:model.py:2097 Deploying ch:amd64/jammy/postgresql-test-app-211
[32mINFO    [0m juju.model:model.py:2097 Deploying local:postgresql-0
[33mWARNING [0m juju.model:model.py:1563 relate is deprecated and will be removed. Use integrate instead.
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql-test-app/0 [allocating] waiting: waiting for machine
  postgresql/0 [allocating] waiting: waiting for machine
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql-test-app/0 [allocating] waiting: agent initialising
  postgresql/0 [allocating] waiting: waiting for machine
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql/0 [allocating] waiting: waiting for machine
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql/0 [allocating] waiting: agent initialising
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql/0 [executing] maintenance: installing PostgreSQL
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql-test-app/0 [idle] active: 
  postgresql/0 [executing] waiting: waiting to start PostgreSQL
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql-test-app/0 [idle] active: received database credentials of the first database
  postgresql/0 [executing] active: Primary
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql-test-app/0 [executing] active: received database credentials of the first database
  postgresql/0 [executing] active: Primary
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql/0 [executing] active: Primary
[32mINFO    [0m integration.test_audit:test_audit.py:35 Checking that the audit plugin is disabled
[32mINFO    [0m integration.test_audit:test_audit.py:62 Enabling the audit plugin
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql/0 [idle] active: Primary
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql/0 [idle] active: Primary
[32mINFO    [0m integration.test_audit:test_audit.py:68 Checking that the audit plugin is enabled
[31mFAILED[0m
[1m------------------------------ live log teardown -------------------------------[0m
[32mINFO    [0m pytest_operator.plugin:plugin.py:903 Model status:

Model  Controller  Cloud/Region         Version  SLA          Timestamp
dev1   lxd         localhost/localhost  3.5.3    unsupported  21:06:12Z

App                  Version  Status  Scale  Charm                Channel        Rev  Exposed  Message
postgresql           14.13    active      1  postgresql                            0  no       
postgresql-test-app           active      1  postgresql-test-app  latest/stable  211  no       received database credentials of the first database

Unit                    Workload  Agent  Machine  Public address  Ports     Message
postgresql-test-app/0*  active    idle   0        10.135.166.153            received database credentials of the first database
postgresql/0*           active    idle   1        10.135.166.143  5432/tcp  Primary

Machine  State    Address         Inst id        Base          AZ  Message
0        started  10.135.166.153  juju-2d378e-0  ubuntu@22.04      Running
1        started  10.135.166.143  juju-2d378e-1  ubuntu@22.04      Running

[32mINFO    [0m pytest_operator.plugin:plugin.py:909 Juju error logs:

machine-0: 20:56:39 ERROR juju.worker.dependency "kvm-container-provisioner" manifold worker returned unexpected error: container types not yet available
machine-0: 20:56:39 ERROR juju.worker.dependency "lxd-container-provisioner" manifold worker returned unexpected error: container types not yet available
unit-postgresql-test-app-0: 20:56:40 ERROR juju.worker.meterstatus error running "meter-status-changed": charm missing from disk
machine-1: 20:57:30 ERROR juju.worker.dependency "lxd-container-provisioner" manifold worker returned unexpected error: container types not yet available
machine-1: 20:57:30 ERROR juju.worker.dependency "kvm-container-provisioner" manifold worker returned unexpected error: container types not yet available
unit-postgresql-0: 20:57:30 ERROR juju.worker.meterstatus error running "meter-status-changed": charm missing from disk

[32mINFO    [0m pytest_operator.plugin:plugin.py:991 Forgetting model main...


=================================== FAILURES ===================================
[31m[1m______________________________ test_audit_plugin _______________________________[0m
Traceback (most recent call last):
  File "/home/ubuntu/postgresql-operator-16/tests/integration/test_audit.py", line 81, in test_audit_plugin
    connection.close()
                  ^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/tenacity/asyncio/__init__.py", line 189, in async_wrapped
    return await copy(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/tenacity/asyncio/__init__.py", line 111, in __call__
    do = await self.iter(retry_state=retry_state)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/tenacity/asyncio/__init__.py", line 153, in iter
    result = await action(retry_state)
             ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/tenacity/_utils.py", line 99, in inner
    return call(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/tenacity/__init__.py", line 418, in exc_check
    raise retry_exc.reraise()
          ^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/tenacity/__init__.py", line 185, in reraise
    raise self.last_attempt.result()
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/tenacity/asyncio/__init__.py", line 114, in __call__
    result = await fn(*args, **kwargs)
                   ^^^^^^^^^^^^^^^^^^^
TypeError: get_primary() missing 1 required positional argument: 'unit_name'

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/_pytest/runner.py", line 341, in from_call
    result: TResult | None = func()
                             ^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/_pytest/runner.py", line 242, in <lambda>
    lambda: runtest_hook(item=item, **kwds), when=when, reraise=reraise
            ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/pluggy/_callers.py", line 139, in _multicall
    raise exception.with_traceback(exception.__traceback__)
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    teardown.throw(exception)  # type: ignore[union-attr]
    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/_pytest/threadexception.py", line 92, in pytest_runtest_call
    yield from thread_exception_runtest_hook()
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/_pytest/threadexception.py", line 68, in thread_exception_runtest_hook
    yield
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    teardown.throw(exception)  # type: ignore[union-attr]
    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 95, in pytest_runtest_call
    yield from unraisable_exception_runtest_hook()
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/_pytest/unraisableexception.py", line 70, in unraisable_exception_runtest_hook
    yield
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    teardown.throw(exception)  # type: ignore[union-attr]
    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/_pytest/logging.py", line 848, in pytest_runtest_call
    yield from self._runtest_for(item, "call")
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/_pytest/logging.py", line 831, in _runtest_for
    yield
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    teardown.throw(exception)  # type: ignore[union-attr]
    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/_pytest/capture.py", line 879, in pytest_runtest_call
    return (yield)
            ^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/pluggy/_callers.py", line 122, in _multicall
    teardown.throw(exception)  # type: ignore[union-attr]
    ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/_pytest/skipping.py", line 257, in pytest_runtest_call
    return (yield)
            ^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    res = hook_impl.function(*args)
          ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/_pytest/runner.py", line 174, in pytest_runtest_call
    item.runtest()
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/_pytest/python.py", line 1627, in runtest
    self.ihook.pytest_pyfunc_call(pyfuncitem=self)
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/pluggy/_hooks.py", line 513, in __call__
    return self._hookexec(self.name, self._hookimpls.copy(), kwargs, firstresult)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/pluggy/_manager.py", line 120, in _hookexec
    return self._inner_hookexec(hook_name, methods, kwargs, firstresult)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/pluggy/_callers.py", line 182, in _multicall
    return outcome.get_result()
           ^^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/pluggy/_result.py", line 100, in get_result
    raise exc.with_traceback(exc.__traceback__)
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/pluggy/_callers.py", line 103, in _multicall
    res = hook_impl.function(*args)
          ^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/_pytest/python.py", line 159, in pytest_pyfunc_call
    result = testfunction(**testargs)
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/pytest_asyncio/plugin.py", line 529, in inner
    _loop.run_until_complete(task)
  File "/usr/lib/python3.12/asyncio/base_events.py", line 687, in run_until_complete
    return future.result()
           ^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/tests/integration/test_audit.py", line 78, in test_audit_plugin
    cursor.execute("SET TIME ZONE 'Europe/Rome';")
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/tenacity/__init__.py", line 443, in __iter__
    do = self.iter(retry_state=retry_state)
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/tenacity/__init__.py", line 376, in iter
    result = action(retry_state)
             ^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/tenacity/__init__.py", line 418, in exc_check
    raise retry_exc.reraise()
          ^^^^^^^^^^^^^^^^^^^
  File "/home/ubuntu/postgresql-operator-16/.tox/integration/lib/python3.12/site-packages/tenacity/__init__.py", line 185, in reraise
    raise self.last_attempt.result()
          ^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/concurrent/futures/_base.py", line 449, in result
    return self.__get_result()
           ^^^^^^^^^^^^^^^^^^^
  File "/usr/lib/python3.12/concurrent/futures/_base.py", line 401, in __get_result
    raise self._exception
  File "/home/ubuntu/postgresql-operator-16/tests/integration/test_audit.py", line 94, in test_audit_plugin
    )
AssertionError: Audit logs were not found when the plugin is enabled.
assert False
------------------------------ Captured log setup ------------------------------
[32mINFO    [0m pytest_operator.plugin:plugin.py:724 Adding model lxd:dev1 on cloud localhost
[32mINFO    [0m pytest_operator.plugin:plugin.py:583 Using tmp_path: /home/ubuntu/postgresql-operator-16/.tox/integration/tmp/pytest/dev10
[32mINFO    [0m pytest_operator.plugin:plugin.py:1127 Building charm postgresql
[32mINFO    [0m pytest_operator.plugin:plugin.py:1132 Built charm postgresql in 87.39s
------------------------------ Captured log call -------------------------------
[32mINFO    [0m juju.model:model.py:2097 Deploying ch:amd64/jammy/postgresql-test-app-211
[32mINFO    [0m juju.model:model.py:2097 Deploying local:postgresql-0
[33mWARNING [0m juju.model:model.py:1563 relate is deprecated and will be removed. Use integrate instead.
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql-test-app/0 [allocating] waiting: waiting for machine
  postgresql/0 [allocating] waiting: waiting for machine
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql-test-app/0 [allocating] waiting: agent initialising
  postgresql/0 [allocating] waiting: waiting for machine
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql/0 [allocating] waiting: waiting for machine
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql/0 [allocating] waiting: agent initialising
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql/0 [executing] maintenance: installing PostgreSQL
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql-test-app/0 [idle] active: 
  postgresql/0 [executing] waiting: waiting to start PostgreSQL
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql-test-app/0 [idle] active: received database credentials of the first database
  postgresql/0 [executing] active: Primary
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql-test-app/0 [executing] active: received database credentials of the first database
  postgresql/0 [executing] active: Primary
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql/0 [executing] active: Primary
[32mINFO    [0m integration.test_audit:test_audit.py:35 Checking that the audit plugin is disabled
[32mINFO    [0m integration.test_audit:test_audit.py:62 Enabling the audit plugin
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql/0 [idle] active: Primary
[32mINFO    [0m juju.model:model.py:2971 Waiting for model:
  postgresql/0 [idle] active: Primary
[32mINFO    [0m integration.test_audit:test_audit.py:68 Checking that the audit plugin is enabled
---------------------------- Captured log teardown -----------------------------
[32mINFO    [0m pytest_operator.plugin:plugin.py:903 Model status:

Model  Controller  Cloud/Region         Version  SLA          Timestamp
dev1   lxd         localhost/localhost  3.5.3    unsupported  21:06:12Z

App                  Version  Status  Scale  Charm                Channel        Rev  Exposed  Message
postgresql           14.13    active      1  postgresql                            0  no       
postgresql-test-app           active      1  postgresql-test-app  latest/stable  211  no       received database credentials of the first database

Unit                    Workload  Agent  Machine  Public address  Ports     Message
postgresql-test-app/0*  active    idle   0        10.135.166.153            received database credentials of the first database
postgresql/0*           active    idle   1        10.135.166.143  5432/tcp  Primary

Machine  State    Address         Inst id        Base          AZ  Message
0        started  10.135.166.153  juju-2d378e-0  ubuntu@22.04      Running
1        started  10.135.166.143  juju-2d378e-1  ubuntu@22.04      Running

[32mINFO    [0m pytest_operator.plugin:plugin.py:909 Juju error logs:

machine-0: 20:56:39 ERROR juju.worker.dependency "kvm-container-provisioner" manifold worker returned unexpected error: container types not yet available
machine-0: 20:56:39 ERROR juju.worker.dependency "lxd-container-provisioner" manifold worker returned unexpected error: container types not yet available
unit-postgresql-test-app-0: 20:56:40 ERROR juju.worker.meterstatus error running "meter-status-changed": charm missing from disk
machine-1: 20:57:30 ERROR juju.worker.dependency "lxd-container-provisioner" manifold worker returned unexpected error: container types not yet available
machine-1: 20:57:30 ERROR juju.worker.dependency "kvm-container-provisioner" manifold worker returned unexpected error: container types not yet available
unit-postgresql-0: 20:57:30 ERROR juju.worker.meterstatus error running "meter-status-changed": charm missing from disk

[32mINFO    [0m pytest_operator.plugin:plugin.py:991 Forgetting model main...
[36m[1m=========================== short test summary info ============================[0m
[31mFAILED[0m tests/integration/test_audit.py::[1mtest_audit_plugin[0m - AssertionError: Audit logs were not found when the plugin is enabled.
assert False
[31m======================== [31m[1m1 failed[0m[31m in 749.45s (0:12:29)[0m[31m =========================[0m
integration: exit 1 (755.51 seconds) /home/ubuntu/postgresql-operator-16> poetry run pytest -v --tb native --log-cli-level=INFO -s --ignore=/home/ubuntu/postgresql-operator-16/tests/unit/ --keep-models -vv --controller lxd --model dev1 tests/integration/test_audit.py pid=3423102
integration: commands_post[0]> mv requirements.txt requirements-last-build.txt
  integration: FAIL code 1 (757.44=setup[0.06]+cmd[1.12,0.74,755.51,0.00] seconds)
  evaluation failed :( (757.52 seconds)
