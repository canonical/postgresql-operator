# Copyright 2021 Canonical Ltd.
# See LICENSE file for licensing details.

type: charm
bases:
  - name: ubuntu
    channel: "22.04"
    architectures: [amd64]
  - name: ubuntu
    channel: "22.04"
    architectures: [arm64]
parts:
  rust-deps:
    plugin: nil
    build-snaps:
      - rustup
    build-packages:
      - libffi-dev
      - libssl-dev
      - pkg-config
      - libpq-dev
    override-build: |
      rustup default stable
  poetry-deps:
    plugin: nil
    build-packages:
      - curl
    build-environment:
      - POETRY_VERSION: "1.8.0"
    override-build: |
      curl -sSL https://install.python-poetry.org | python3 -
      ln -sf $HOME/.local/bin/poetry /usr/local/bin/poetry

      /usr/bin/python3 -m pip install pip==24.2
  charm:
    after: [rust-deps, poetry-deps]
    plugin: poetry
    source: .
    poetry-with:
      - charm-libs
  libpq:
    build-packages:
      - libpq-dev
    plugin: dump
    source: /usr/lib/
    source-type: local
    prime:
      - lib/
    organize:
      "*-linux-gnu/libpq.so*": lib/
