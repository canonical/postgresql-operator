[32mINFO    [0m integration.conftest:conftest.py:117 Setting up TLS certificates
[32mINFO    [0m integration.conftest:conftest.py:182 Setting up microceph
[32mINFO    [0m integration.conftest:conftest.py:211 Set up microceph
[33mWARNING [0m juju.client.connection:connection.py:858 unexpected facade SSHServer received from the controller
[32mINFO    [0m pytest_operator.plugin:plugin.py:806 Connecting to existing model concierge-lxd:testing on unspecified cloud
[33mWARNING [0m juju.client.connection:connection.py:858 unexpected facade SSHServer received from the controller
[33mWARNING [0m juju.client.connection:connection.py:858 unexpected facade SSHSession received from the controller
[33mWARNING [0m juju.client.connection:connection.py:858 unexpected facade SSHTunneler received from the controller
[33mWARNING [0m juju.client.connection:connection.py:858 unexpected facade SSHServer received from the controller
[33mWARNING [0m juju.client.connection:connection.py:858 unexpected facade SSHServer received from the controller
[32mINFO    [0m juju.model:__init__.py:2301 Deploying ch:amd64/jammy/s3-integrator-145
[32mINFO    [0m juju.model:__init__.py:2301 Deploying ch:amd64/noble/self-signed-certificates-317
[32mINFO    [0m juju.model:__init__.py:2301 Deploying local:postgresql-0
[33mWARNING [0m juju.model:__init__.py:1683 relate is deprecated and will be removed. Use integrate instead.
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  postgresql-ceph/0 [allocating] waiting: waiting for machine
  postgresql-ceph/1 [allocating] waiting: waiting for machine
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  postgresql-ceph/0 [allocating] waiting: waiting for machine
  postgresql-ceph/1 [allocating] waiting: waiting for machine
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  postgresql-ceph/0 [allocating] waiting: waiting for machine
  postgresql-ceph/1 [allocating] waiting: waiting for machine
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  postgresql-ceph/0 [allocating] waiting: waiting for machine
  postgresql-ceph/1 [allocating] waiting: waiting for machine
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  postgresql-ceph/0 [allocating] waiting: waiting for machine
  postgresql-ceph/1 [allocating] waiting: waiting for machine
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  postgresql-ceph/0 [executing] maintenance: installing PostgreSQL
  postgresql-ceph/1 [executing] maintenance: installing PostgreSQL
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  postgresql-ceph/0 [executing] waiting: waiting to start PostgreSQL
  postgresql-ceph/1 [executing] waiting: waiting to start PostgreSQL
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  postgresql-ceph/0 [executing] active: Primary (degraded)
  postgresql-ceph/1 [executing] waiting: awaiting for cluster to start
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  postgresql-ceph/0 [executing] maintenance: reconfiguring cluster
  postgresql-ceph/1 [executing] waiting: awaiting for cluster to start
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  postgresql-ceph/0 [idle] active: Primary
  postgresql-ceph/1 [idle] active: 
[32mINFO    [0m integration.backup_helpers:backup_helpers.py:58 configuring S3 integrator for ceph
[33mWARNING [0m juju.model:__init__.py:1683 relate is deprecated and will be removed. Use integrate instead.
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  postgresql-ceph/0 [idle] active: Primary
  postgresql-ceph/1 [idle] active: 
  s3-integrator/0 [executing] active: 
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  postgresql-ceph/0 [executing] active: Primary
  postgresql-ceph/1 [executing] active: 
[32mINFO    [0m integration.backup_helpers:backup_helpers.py:310 1: creating table
[32mINFO    [0m integration.backup_helpers:backup_helpers.py:313 1: creating backup b1
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  s3-integrator/0 [idle] active: 
  self-signed-certificates/0 [idle] active: 
  postgresql-ceph/0 [executing] active: Primary
  postgresql-ceph/1 [idle] active: 
[32mINFO    [0m integration.backup_helpers:backup_helpers.py:574 listing the available backups
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  s3-integrator/0 [idle] active: 
  self-signed-certificates/0 [idle] active: 
  postgresql-ceph/0 [idle] active: Primary
  postgresql-ceph/1 [idle] active: 
[32mINFO    [0m integration.backup_helpers:backup_helpers.py:321 1: creating test data td1
[32mINFO    [0m integration.backup_helpers:backup_helpers.py:324 1: get timestamp ts1
[32mINFO    [0m integration.backup_helpers:backup_helpers.py:334 1: creating test data td2
[32mINFO    [0m integration.backup_helpers:backup_helpers.py:337 1: switching wal
[32mINFO    [0m integration.backup_helpers:backup_helpers.py:340 1: scaling down to do restore
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  s3-integrator/0 [idle] active: 
  self-signed-certificates/0 [executing] active: 
  postgresql-ceph/0 [executing] active: Primary
  postgresql-ceph/1 [executing] active: 
[32mINFO    [0m juju.model:__init__.py:3254 Waiting for model:
  postgresql-ceph/1 [executing] active:
[32mINFO    [0m pytest_operator.plugin:plugin.py:951 Model status:

Model    Controller     Cloud/Region         Version  SLA          Timestamp
testing  concierge-lxd  localhost/localhost  3.6.14   unsupported  00:19:01Z

App                       Version  Status  Scale  Charm                     Channel        Rev  Exposed  Message
postgresql-ceph           14.20    active      2  postgresql                                 0  no       
s3-integrator                      active      1  s3-integrator             latest/stable  145  no       
self-signed-certificates           active      1  self-signed-certificates  1/stable       317  no       

Unit                         Workload  Agent  Machine  Public address  Ports     Message
postgresql-ceph/0*           active    idle   2        10.14.61.176    5432/tcp  Primary
postgresql-ceph/1            error     idle   3        10.14.61.229    5432/tcp  hook failed: "certificates-relation-broken"
s3-integrator/0*             active    idle   0        10.14.61.168              
self-signed-certificates/0*  active    idle   1        10.14.61.156              

Machine  State    Address       Inst id        Base          AZ             Message
0        started  10.14.61.168  juju-8de331-0  ubuntu@22.04  runnervmwffz4  Running
1        started  10.14.61.156  juju-8de331-1  ubuntu@24.04  runnervmwffz4  Running
2        started  10.14.61.176  juju-8de331-2  ubuntu@22.04  runnervmwffz4  Running
3        started  10.14.61.229  juju-8de331-3  ubuntu@22.04  runnervmwffz4  Running

[32mINFO    [0m pytest_operator.plugin:plugin.py:957 Juju error logs:

machine-1: 00:12:35 ERROR juju.worker.dependency "lxd-container-provisioner" manifold worker returned unexpected error: container types not yet available
machine-1: 00:12:35 ERROR juju.worker.dependency "kvm-container-provisioner" manifold worker returned unexpected error: container types not yet available
machine-0: 00:12:44 ERROR juju.worker.dependency "lxd-container-provisioner" manifold worker returned unexpected error: container types not yet available
machine-0: 00:12:44 ERROR juju.worker.dependency "kvm-container-provisioner" manifold worker returned unexpected error: container types not yet available
machine-2: 00:13:43 ERROR juju.worker.dependency "lxd-container-provisioner" manifold worker returned unexpected error: container types not yet available
machine-2: 00:13:43 ERROR juju.worker.dependency "kvm-container-provisioner" manifold worker returned unexpected error: container types not yet available
unit-self-signed-certificates-0: 00:13:45 ERROR unit.self-signed-certificates/0.juju-log At least 1 matching relation ID not found with the relation name 'send-ca-cert'
machine-3: 00:13:52 ERROR juju.worker.dependency "kvm-container-provisioner" manifold worker returned unexpected error: container types not yet available
machine-3: 00:13:52 ERROR juju.worker.dependency "lxd-container-provisioner" manifold worker returned unexpected error: container types not yet available
unit-self-signed-certificates-0: 00:14:29 ERROR unit.self-signed-certificates/0.juju-log certificates:4: At least 1 matching relation ID not found with the relation name 'send-ca-cert'
unit-postgresql-ceph-0: 00:14:34 ERROR unit.postgresql-ceph/0.juju-log Unable to get the state of the cluster
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-ceph-0/charm/src/cluster.py", line 569, in are_replicas_up
    members = self.cluster_status()
  File "/var/lib/juju/agents/unit-postgresql-ceph-0/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 1153, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-postgresql-ceph-0/charm/src/cluster.py", line 369, in cluster_status
    raise RetryError(
tenacity.RetryError: RetryError[<Future at 0x7f937ff0b2b0 state=finished raised Exception>]
unit-self-signed-certificates-0: 00:14:36 ERROR unit.self-signed-certificates/0.juju-log certificates:4: At least 1 matching relation ID not found with the relation name 'send-ca-cert'
unit-self-signed-certificates-0: 00:14:41 ERROR unit.self-signed-certificates/0.juju-log At least 1 matching relation ID not found with the relation name 'send-ca-cert'
unit-postgresql-ceph-0: 00:14:46 ERROR unit.postgresql-ceph/0.juju-log Failed to list PostgreSQL database users: could not translate host name "None" to address: Temporary failure in name resolution

unit-self-signed-certificates-0: 00:14:47 ERROR unit.self-signed-certificates/0.juju-log certificates:4: At least 1 matching relation ID not found with the relation name 'send-ca-cert'
unit-self-signed-certificates-0: 00:15:12 ERROR unit.self-signed-certificates/0.juju-log certificates:4: At least 1 matching relation ID not found with the relation name 'send-ca-cert'
unit-self-signed-certificates-0: 00:15:49 ERROR unit.self-signed-certificates/0.juju-log At least 1 matching relation ID not found with the relation name 'send-ca-cert'
unit-self-signed-certificates-0: 00:18:29 ERROR unit.self-signed-certificates/0.juju-log At least 1 matching relation ID not found with the relation name 'send-ca-cert'
unit-self-signed-certificates-0: 00:18:39 ERROR unit.self-signed-certificates/0.juju-log At least 1 matching relation ID not found with the relation name 'send-ca-cert'
unit-self-signed-certificates-0: 00:18:49 ERROR unit.self-signed-certificates/0.juju-log At least 1 matching relation ID not found with the relation name 'send-ca-cert'
unit-postgresql-ceph-1: 00:19:00 ERROR unit.postgresql-ceph/1.juju-log certificates:4: Uncaught exception while in charm code:
Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/urllib3/connectionpool.py", line 534, in _make_request
    response = conn.getresponse()
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/urllib3/connection.py", line 571, in getresponse
    httplib_response = super().getresponse()
  File "/usr/lib/python3.10/http/client.py", line 1395, in getresponse
    response.begin()
  File "/usr/lib/python3.10/http/client.py", line 323, in begin
    version, status, reason = self._read_status()
  File "/usr/lib/python3.10/http/client.py", line 284, in _read_status
    line = str(self.fp.readline(_MAXLINE + 1), "iso-8859-1")
  File "/usr/lib/python3.10/socket.py", line 705, in readinto
    return self._sock.recv_into(b)
  File "/usr/lib/python3.10/ssl.py", line 1303, in recv_into
    return self.read(nbytes, buffer)
  File "/usr/lib/python3.10/ssl.py", line 1159, in read
    return self._sslobj.read(len, buffer)
TimeoutError: The read operation timed out

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/requests/adapters.py", line 644, in send
    resp = conn.urlopen(
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/urllib3/connectionpool.py", line 841, in urlopen
    retries = retries.increment(
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/urllib3/util/retry.py", line 490, in increment
    raise reraise(type(error), error, _stacktrace)
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/urllib3/util/util.py", line 39, in reraise
    raise value
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/urllib3/connectionpool.py", line 787, in urlopen
    response = self._make_request(
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/urllib3/connectionpool.py", line 536, in _make_request
    self._raise_timeout(err=e, url=url, timeout_value=read_timeout)
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/urllib3/connectionpool.py", line 367, in _raise_timeout
    raise ReadTimeoutError(
urllib3.exceptions.ReadTimeoutError: HTTPSConnectionPool(host='10.14.61.229', port=8008): Read timed out. (read timeout=10)

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/tenacity/__init__.py", line 480, in __call__
    result = fn(*args, **kwargs)
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/src/cluster.py", line 1026, in bulk_update_parameters_controller_by_patroni
    r = requests.patch(
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/requests/api.py", line 145, in patch
    return request("patch", url, data=data, **kwargs)
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/requests/api.py", line 59, in request
    return session.request(method=method, url=url, **kwargs)
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/requests/sessions.py", line 589, in request
    resp = self.send(prep, **send_kwargs)
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/requests/sessions.py", line 703, in send
    r = adapter.send(request, **kwargs)
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/requests/adapters.py", line 690, in send
    raise ReadTimeout(e, request=request)
requests.exceptions.ReadTimeout: HTTPSConnectionPool(host='10.14.61.229', port=8008): Read timed out. (read timeout=10)

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/src/charm.py", line 2607, in <module>
    main(PostgresqlOperatorCharm)
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/ops/__init__.py", line 356, in __call__
    return _main.main(charm_class=charm_class, use_juju_for_storage=use_juju_for_storage)
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/ops/_main.py", line 502, in main
    manager.run()
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/ops/_main.py", line 486, in run
    self._emit()
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/ops/_main.py", line 421, in _emit
    self._emit_charm_event(self.dispatcher.event_name)
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/ops/_main.py", line 465, in _emit_charm_event
    event_to_emit.emit(*args, **kwargs)
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 351, in emit
    framework._emit(event)
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 924, in _emit
    self._reemit(event_path)
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/ops/framework.py", line 1030, in _reemit
    custom_handler(event)
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 1153, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/lib/charms/postgresql_k8s/v0/postgresql_tls.py", line 130, in _on_tls_relation_broken
    if not self.charm.update_config():
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 1153, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/src/charm.py", line 2250, in update_config
    self._api_update_config()
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 1153, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/src/charm.py", line 2168, in _api_update_config
    self._patroni.bulk_update_parameters_controller_by_patroni(cfg_patch, base_patch)
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/lib/charms/tempo_coordinator_k8s/v0/charm_tracing.py", line 1153, in wrapped_function
    return callable(*args, **kwargs)  # type: ignore
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/tenacity/__init__.py", line 338, in wrapped_f
    return copy(f, *args, **kw)
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/tenacity/__init__.py", line 477, in __call__
    do = self.iter(retry_state=retry_state)
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/tenacity/__init__.py", line 378, in iter
    result = action(retry_state)
  File "/var/lib/juju/agents/unit-postgresql-ceph-1/charm/venv/lib/python3.10/site-packages/tenacity/__init__.py", line 421, in exc_check
    raise retry_exc from fut.exception()
tenacity.RetryError: RetryError[<Future at 0x7fb6d22569e0 state=finished raised ReadTimeout>]
unit-postgresql-ceph-1: 00:19:00 ERROR juju.worker.uniter.operation hook "certificates-relation-broken" (via hook dispatching script: dispatch) failed: exit status 1

[32mINFO    [0m pytest_operator.plugin:plugin.py:1039 Forgetting model main...